<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Messenger Dark Firebase</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg:#18191a;
      --panel:#242526;
      --muted:#b0b3b8;
      --accent:#0084ff;
      --bubble:#3a3b3c;
      --me:#0084ff;
      font-family:'Inter',system-ui,-apple-system,'Segoe UI',Roboto,'Helvetica Neue',Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:#e4e6eb}
    .app{display:flex;max-width:1100px;height:100vh;margin:0 auto;}
    .sidebar{width:320px;background:var(--panel);display:flex;flex-direction:column;border-right:1px solid #3e4042}
    .search{padding:12px}
    .search input{width:100%;padding:10px;border-radius:8px;border:none;background:#3a3b3c;color:#fff}
    .contacts{flex:1;overflow:auto}
    .contact{display:flex;align-items:center;padding:12px;gap:12px;cursor:pointer}
    .contact:hover{background:#3a3b3c}
    .avatar{width:44px;height:44px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,#667eea,#764ba2);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
    .meta{flex:1;display:flex;justify-content:space-between;align-items:center}
    .meta .name{font-weight:600}
    .meta .last{font-size:13px;color:var(--muted)}
    .main{flex:1;display:flex;flex-direction:column;background:var(--panel)}
    .header{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid #3e4042}
    .header .title{font-weight:600}
    .header .subtitle{font-size:13px;color:var(--muted);margin-left:8px}
    .messages{flex:1;padding:20px;overflow:auto;background:var(--bg)}
    .bubble-row{display:flex;margin-bottom:10px;align-items:flex-end;position:relative}
    .bubble{max-width:70%;padding:10px 14px;border-radius:18px;line-height:1.4;font-size:14px;position:relative}
    .from{background:var(--bubble);border-bottom-left-radius:4px}
    .to{background:var(--me);margin-left:auto;border-bottom-right-radius:4px;color:#fff}
    .time{display:block;font-size:11px;color:var(--muted);margin-top:6px}
    .delete-btn,.edit-btn{position:absolute;top:-8px;background:#555;color:#fff;border:none;border-radius:50%;width:20px;height:20px;cursor:pointer;font-size:12px;display:none;}
    .delete-btn{right:-8px;background:#ff5c5c}
    .edit-btn{right:18px;background:#0078ff}
    .bubble-row:hover .delete-btn,.bubble-row:hover .edit-btn{display:block}
    .composer{padding:12px;border-top:1px solid #3e4042;display:flex;gap:10px;align-items:center}
    .composer .actions{display:flex;gap:8px}
    .composer input[type='text']{flex:1;padding:10px 12px;border-radius:999px;border:1px solid #3a3b3c;background:#3a3b3c;color:#fff}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
    @media(max-width:880px){.sidebar{display:none}.app{max-width:100%;height:100vh}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="search">
        <input id="searchContacts" placeholder="Search conversations or user ID"/>
      </div>
      <div class="contacts" id="contactsList" aria-live="polite">
        <div class="no-contacts">Loading conversations...</div>
      </div>
    </aside>

    <main class="main">
      <div class="header">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="avatar" id="chatAvatar">?</div>
          <div>
            <div class="title" id="chatName">Select a conversation</div>
            <div class="subtitle" id="chatStatus">â€“</div>
          </div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button class="btn" id="newChat">New Chat</button>
        </div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <div class="actions">
          <label title="Attach file" style="cursor:pointer">
            <input id="fileInput" type="file" style="display:none"/>
            ðŸ“Ž
          </label>
          <button id="emojiBtn" title="Emoji">ðŸ˜Š</button>
        </div>
        <input id="msgInput" type="text" placeholder="Type a message... (press Enter to send)"/>
        <button class="btn" id="sendBtn">Send</button>
      </div>
    </main>
  </div>

  <script type="module">
    import {initializeApp} from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import {
      getAuth,onAuthStateChanged,signOut
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import {
      getDatabase,ref,onChildAdded,get,push,set,update,remove
    } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    // ðŸ”¹ your Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyAhT_VolZsIz7F_AxnVkagd85ngXCGErQw",
      authDomain: "your-app.firebaseapp.com",
      databaseURL: "https://your-app.firebaseio.com",
      projectId: "your-app",
      storageBucket: "your-app.appspot.com",
      messagingSenderId: "1234567890",
      appId: "1:1234567890:web:abc123"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // UI refs
    const contactsList=document.getElementById('contactsList');
    const messagesEl=document.getElementById('messages');
    const chatNameEl=document.getElementById('chatName');
    const chatAvatarEl=document.getElementById('chatAvatar');
    const chatStatusEl=document.getElementById('chatStatus');
    const msgInput=document.getElementById('msgInput');
    const sendBtn=document.getElementById('sendBtn');

    let currentUser=null,activeChatId=null;
    let chatsMeta={},messageListeners={};

    function escapeHtml(s){return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;')}

    function formatTime(ts){
      if(!ts) return "";
      return new Date(ts).toLocaleTimeString([], {hour:'2-digit', minute:'2-digit'});
    }

    function renderContacts(filter=""){
      contactsList.innerHTML="";
      const ids=Object.keys(chatsMeta);
      if(ids.length===0){
        contactsList.innerHTML=`<div class="no-contacts">No conversations</div>`;
        return;
      }
      ids.sort((a,b)=>chatsMeta[b].latestMsgTs-chatsMeta[a].latestMsgTs);
      ids.forEach(chatId=>{
        const meta=chatsMeta[chatId];
        if(meta.name && !meta.name.toLowerCase().includes(filter.toLowerCase())) return;
        const el=document.createElement("div");
        el.className="contact";
        el.innerHTML=`
          <div class="avatar">${meta.avatar||"?"}</div>
          <div class="meta">
            <div style="display:flex;flex-direction:column">
              <div class="name">${meta.name||"Unknown"}</div>
              <div class="last">${meta.latestMsgText||""}</div>
            </div>
            <div class="time">${formatTime(meta.latestMsgTs)}</div>
          </div>`;
        el.onclick=()=>openChat(chatId);
        contactsList.appendChild(el);
      });
    }

    async function openChat(chatId){
      activeChatId=chatId;
      const meta=chatsMeta[chatId];
      chatNameEl.textContent=meta.name||"Unknown";
      chatAvatarEl.textContent=meta.avatar||"?";
      chatStatusEl.textContent="Online";
      messagesEl.innerHTML="";
      const msgsRef=ref(db,`chats/${chatId}/messages`);
      const snap=await get(msgsRef);
      if(snap.exists()){
        snap.forEach(m=>{
          renderMessage(m.key,m.val());
        });
      }
    }

    function renderMessage(id,m){
      const row=document.createElement("div");
      row.className="bubble-row";
      const b=document.createElement("div");
      b.className="bubble "+(m.sender===currentUser.uid?"to":"from");
      b.innerHTML=`<div>${escapeHtml(m.text||"")}</div><div class='time'>${formatTime(m.ts)}</div>`;
      if(m.sender===currentUser.uid){
        const del=document.createElement("button");
        del.className="delete-btn"; del.textContent="Ã—";
        del.onclick=()=>remove(ref(db,`chats/${activeChatId}/messages/${id}`));
        const edit=document.createElement("button");
        edit.className="edit-btn"; edit.textContent="âœŽ";
        edit.onclick=()=>{
          const newTxt=prompt("Edit message:",m.text);
          if(newTxt!==null){
            update(ref(db,`chats/${activeChatId}/messages/${id}`),{text:newTxt});
          }
        };
        row.appendChild(del); row.appendChild(edit);
      }
      row.appendChild(b);
      messagesEl.appendChild(row);
      messagesEl.scrollTop=messagesEl.scrollHeight;
    }

    function attachMessageListener(chatId){
      if(messageListeners[chatId]) return;
      const msgsRef=ref(db,`chats/${chatId}/messages`);
      messageListeners[chatId]=msgsRef;
      get(msgsRef).then(snap=>{
        if(snap.exists()){
          let latest=null;
          snap.forEach(m=>{let v=m.val(); if(!latest||v.ts>latest.ts) latest=v;});
          if(latest){
            chatsMeta[chatId].latestMsgTs=latest.ts;
            chatsMeta[chatId].latestMsgText=(latest.text||"").slice(0,80);
          }
          renderContacts();
        }
      });
      onChildAdded(msgsRef,msgSnap=>{
        const m=msgSnap.val(); if(!m) return;
        chatsMeta[chatId].latestMsgTs=m.ts;
        chatsMeta[chatId].latestMsgText=(m.text||"").slice(0,80);
        if(activeChatId===chatId){ renderMessage(msgSnap.key,m); }
        renderContacts();
      });
    }

    sendBtn.onclick=()=>{
      const text=msgInput.value.trim();
      if(!text||!activeChatId) return;
      const msgRef=push(ref(db,`chats/${activeChatId}/messages`));
      set(msgRef,{sender:currentUser.uid,text,ts:Date.now()});
      msgInput.value="";
    };

    msgInput.addEventListener("keydown",e=>{
      if(e.key==="Enter"){ e.preventDefault(); sendBtn.click(); }
    });

    onAuthStateChanged(auth,async(user)=>{
      if(!user){ alert("Not logged in"); return; }
      currentUser=user;
      const meSnap=await get(ref(db,"users/"+user.uid));
      if(meSnap.exists()){
        const me=meSnap.val();
        console.log("Logged in as",me.name,me.idNumber);
      }
      const chatsRoot=ref(db,"chats");
      onChildAdded(chatsRoot,snap=>{
        const chatId=snap.key;
        if(!chatId.includes(user.uid)) return;
        if(!chatsMeta[chatId]){
          chatsMeta[chatId]={latestMsgTs:0,latestMsgText:"",name:"Chat "+chatId,avatar:"?"};
        }
        attachMessageListener(chatId);
        renderContacts();
      });
    });
  </script>
</body>
</html>
