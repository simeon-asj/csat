<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>User Dashboard</title>
<style>
body{
  background:#121212;
  color:#fff;
  font-family:Poppins,sans-serif;
  padding:30px;
  position:relative;
}
h2{margin-bottom:20px;}
input{
  padding:10px;
  width:250px;
  border:none;
  border-radius:6px;
  background:#262626;
  color:#fff;
}
button{
  padding:10px 20px;
  margin-left:10px;
  background:#4CAF50;
  color:#fff;
  border:none;
  border-radius:6px;
  cursor:pointer;
}
button:hover{background:#43a047;}
.result{
  margin-top:20px;
  background:#1e1e1e;
  padding:20px;
  border-radius:10px;
  min-height:60px;
}
.logout{
  position:absolute;
  top:20px;
  right:20px;
  background:#e53935;
}
.logout:hover{background:#d32f2f;}
.uid-box{
  background:#1e1e1e;
  padding:15px;
  border-radius:10px;
  margin-bottom:25px;
}
</style>
</head>
<body>

<!-- ✅ Logged in user info -->
<div class="uid-box">
  <strong>Name:</strong> <span id="userName">Loading…</span><br>
  <strong>Email:</strong> <span id="userEmail">Loading…</span><br>
  <strong>Your ID Number:</strong> <span id="userIdNumber">Loading…</span>
</div>

<h2>🔎 Search User by ID Number</h2>
<input type="text" id="searchId" placeholder="Enter ID (e.g. USR-ABC123)">
<button id="searchBtn">Search</button>

<div class="result" id="result"></div>
<button class="logout" id="logoutBtn">Logout</button>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, get } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAhT_VolZsIz7F_AxnVkagd85ngXCGErQw",
  authDomain: "csat-2d59c.firebaseapp.com",
  databaseURL: "https://csat-2d59c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "csat-2d59c",
  storageBucket: "csat-2d59c.firebasestorage.app",
  messagingSenderId: "250094013303",
  appId: "1:250094013303:web:6e6dd3ee0dcac726486f72",
  measurementId: "G-YEJ32DTM64"
};

const app  = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db   = getDatabase(app);

const resultDiv     = document.getElementById("result");
const userNameSpan  = document.getElementById("userName");
const userEmailSpan = document.getElementById("userEmail");
const userIdSpan    = document.getElementById("userIdNumber");

// ✅ Protect page & load current user's data
onAuthStateChanged(auth, async (user)=>{
  if(!user){
    window.location.href="index.html";
  } else {
    userEmailSpan.textContent = user.email || "No email";

    // 🔎 Get custom idNumber & name from DB
    const snap = await get(ref(db,"users/"+user.uid));
    if(snap.exists()){
      const data = snap.val();
      userNameSpan.textContent  = data.name || "(no name)";
      userIdSpan.textContent    = data.idNumber || "No ID Number saved";
    } else {
      userNameSpan.textContent = "(user record not found)";
      userIdSpan.textContent   = "N/A";
    }
  }
});

// ✅ Search by custom ID Number
document.getElementById("searchBtn").addEventListener("click", async ()=>{
  const idInput = document.getElementById("searchId").value.trim();
  if(!idInput){ resultDiv.textContent="Enter an ID Number."; return; }

  const snapshot = await get(ref(db,"users"));
  let found=false;
  snapshot.forEach(childSnap=>{
    const data = childSnap.val();
    if(data.idNumber === idInput){
      resultDiv.innerHTML = `<b>Name:</b> ${data.name}<br>
                             <b>Email:</b> ${data.email}<br>
                             <b>ID Number:</b> ${data.idNumber}`;
      found=true;
    }
  });
  if(!found) resultDiv.textContent="❌ No user found for this ID Number.";
});

// ✅ Logout
document.getElementById("logoutBtn").addEventListener("click", async ()=>{
  await signOut(auth);
  window.location.href="index.html";
});
</script>
</body>
</html>
