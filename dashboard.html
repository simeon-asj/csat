<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard</title>
  <style>
    /* ===== Base ===== */
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #0e0e0e;
      color: #fff;
      height: 100vh;
      display: flex;
    }
    button, input {
      outline: none;
      border: none;
      font-family: inherit;
    }

    /* ===== Sidebar ===== */
    .sidebar {
      width: 260px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #262626;
    }
    #userInfo {
      padding: 12px;
      background: #111;
      border-bottom: 1px solid #262626;
      font-size: 13px;
    }
    #userInfo b {
      font-weight: 600;
    }
    #userId {
      cursor: pointer;
      color: #03a9f4;
      text-decoration: underline;
    }
    #userId:hover {
      color: #29b6f6;
    }
    .searchBox {
      display: flex;
      gap: 4px;
      padding: 8px;
      border-bottom: 1px solid #262626;
    }
    .searchBox input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 5px;
      background: #242424;
      color: #fff;
      font-size: 13px;
    }
    .searchBox button {
      padding: 6px 8px;
      border-radius: 5px;
      background: #e91e63;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    #chatList {
      flex: 1;
      overflow-y: auto;
      font-size: 13px;
    }
    .chat-item {
      display: flex;
      flex-direction: column;
      padding: 10px;
      border-bottom: 1px solid #262626;
      cursor: pointer;
    }
    .chat-item:hover {
      background: #2a2a2a;
    }
    .chat-item .top-line {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .chat-item .name-id {
      /* Bold when unread */
    }
    .chat-item.unread .name-id {
      font-weight: bold;
    }
    .chat-item .latest-msg {
      color: #aaa;
      font-size: 12px;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .online-label {
      color: #4caf50;
      font-size: 12px;
      align-self: center;
    }

    /* ===== Main ===== */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 12px 16px;
      background: #111;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 1px solid #262626;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logout {
      padding: 4px 10px;
      border-radius: 5px;
      background: #e53935;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .logout:hover {
      background: #d32f2f;
    }

    /* ===== Messages ===== */
    .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #121212;
    }
    .msg {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4em;
      position: relative;
      word-wrap: break-word;
    }
    .msg.me {
      align-self: flex-end;
      background: #ff0073;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.other {
      align-self: flex-start;
      background: #2a2a2a;
      color: #fff;
      border-bottom-left-radius: 4px;
    }

    /* ===== Input Row ===== */
    .inputRow {
      display: flex;
      padding: 12px 16px;
      gap: 8px;
      border-top: 1px solid #262626;
      background: #111;
    }
    .inputRow input {
      flex: 1;
      padding: 10px 16px;
      border-radius: 20px;
      background: #242424;
      color: #fff;
      font-size: 14px;
    }
    .inputRow button {
      padding: 10px 16px;
      border-radius: 20px;
      background: #e91e63;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .inputRow button:hover {
      background: #d81b60;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <!-- User Info Bar -->
    <div id="userInfo">
      Logged in as: <b id="userName">Loading...</b><br>
      ID: <small id="userId" title="Click to copy">Loading...</small>
    </div>
    <div class="searchBox">
      <input id="searchUser" placeholder="Search IDâ€¦">
      <button id="searchBtn">Go</button>
    </div>
    <div id="chatList"></div>
  </div>

  <!-- Main Chat -->
  <div class="main">
    <div id="chatHeader" class="header">
      Select a user
      <button id="logoutBtn" class="logout">Logout</button>
    </div>
    <div id="messages" class="messages"></div>
    <div class="inputRow">
      <input id="msgInput" placeholder="Type a message">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Notification Sound -->
  <audio id="notifSound" src="https://notificationsounds.com/storage/sounds/file-sounds-1152-pristine.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, get, child, push, set, onChildAdded } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhT_VolZsIz7F_AxnVkagd85ngXCGErQw",
      authDomain: "csat-2d59c.firebaseapp.com",
      databaseURL: "https://csat-2d59c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "csat-2d59c",
      storageBucket: "csat-2d59c.firebasestorage.app",
      messagingSenderId: "250094013303",
      appId: "1:250094013303:web:6e6dd3ee0dcac726486f72",
      measurementId: "G-YEJ32DTM64"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const logoutBtn   = document.getElementById("logoutBtn");
    const chatList    = document.getElementById("chatList");
    const msgInput    = document.getElementById("msgInput");
    const sendBtn     = document.getElementById("sendBtn");
    const chatHeader  = document.getElementById("chatHeader");
    const messagesDiv = document.getElementById("messages");
    const searchBtn   = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchUser");
    const notifSound  = document.getElementById("notifSound");
    const userNameEl  = document.getElementById("userName");
    const userIdEl    = document.getElementById("userId");

    let currentUser = null;
    let activeChatId = null;
    // stores metadata for each chat
    let chatsMeta = {};

    function sortChatIdsByLatest(chatIds) {
      return chatIds.sort((a, b) => {
        const ta = chatsMeta[a]?.latestMsgTs || 0;
        const tb = chatsMeta[b]?.latestMsgTs || 0;
        return tb - ta;
      });
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "index.html";
        return;
      }
      currentUser = user;

      // get user name & ID
      const usnap = await get(ref(db, "users/" + currentUser.uid));
      if (usnap.exists()) {
        const u = usnap.val();
        userNameEl.textContent = u.name || "N/A";
        userIdEl.textContent = u.idNumber || "N/A";
      }

      // Listen for new messages per chat to update metadata
      const chatsRef = ref(db, "chats");
      onChildAdded(chatsRef, snap => {
        const chatId = snap.key;
        // only track chats involving this user
        const ids = chatId.split("_");
        if (!ids.includes(currentUser.uid)) return;

        // Initialize meta if not yet
        if (!chatsMeta[chatId]) {
          chatsMeta[chatId] = {
            latestMsgTs: 0,
            latestMsgText: "",
            unread: false
          };
        }

        const msgsRef = ref(db, `chats/${chatId}/messages`);
        onChildAdded(msgsRef, msgSnap => {
          const m = msgSnap.val();
          const ts = m.ts || 0;
          // update if newer
          if (ts > (chatsMeta[chatId].latestMsgTs || 0)) {
            chatsMeta[chatId].latestMsgTs = ts;
            chatsMeta[chatId].latestMsgText = m.text || "";
          }
          // If message is from someone else, and this chat is not open, mark unread + sound
          if (m.sender !== currentUser.uid && activeChatId !== chatId) {
            chatsMeta[chatId].unread = true;
            // Play sound for new unread
            notifSound.play().catch(e => console.warn("Notif sound error:", e));
            renderChatList();
          }
          // If this chat is active, then it's read
          if (activeChatId === chatId) {
            chatsMeta[chatId].unread = false;
            renderChatList();
          }
        });
      });

      // Initial render once metadata may start filling
      renderChatList();
    });

    userIdEl.addEventListener("click", () => {
      navigator.clipboard.writeText(userIdEl.textContent)
        .then(() => alert("User ID copied to clipboard!"))
        .catch(() => alert("Failed to copy ID."));
    });

    logoutBtn.onclick = async () => {
      await signOut(auth);
      location.href = "index.html";
    };

    function renderChatList() {
      chatList.innerHTML = "";
      const chatsRef = ref(db, "chats");
      get(chatsRef).then(chatsSnap => {
        const chatIds = [];
        chatsSnap.forEach(snap => {
          const chatId = snap.key;
          const data = snap.val();
          if (!data.messages) return;
          const ids = chatId.split("_");
          if (!ids.includes(currentUser.uid)) return;
          chatIds.push(chatId);
        });

        const sorted = sortChatIdsByLatest(chatIds);

        sorted.forEach(chatId => {
          const meta = chatsMeta[chatId] || { latestMsgTs: 0, latestMsgText: "", unread: false };
          const ids = chatId.split("_");
          const otherUid = ids[0] === currentUser.uid ? ids[1] : ids[0];
          get(child(ref(db), "users/" + otherUid)).then(uSnap => {
            if (!uSnap.exists()) return;
            const u = uSnap.val();
            const div = document.createElement("div");
            div.className = "chat-item" + (meta.unread ? " unread" : "");

            // Name + online label container
            const topLine = document.createElement("div");
            topLine.className = "top-line";

            // Name & ID
            const nameId = document.createElement("div");
            nameId.className = "name-id";
            nameId.innerText = u.name;  // just name as in your example
            topLine.appendChild(nameId);

            // Online label on the right
            const onlineLabel = document.createElement("div");
            onlineLabel.className = "online-label";
            onlineLabel.innerText = "online";
            topLine.appendChild(onlineLabel);

            div.appendChild(topLine);

            // Latest message preview
            const lm = document.createElement("div");
            lm.className = "latest-msg";
            lm.innerText = meta.latestMsgText;
            div.appendChild(lm);

            // click to open
            div.onclick = () => {
              openChat(chatId, u);
            };
            chatList.appendChild(div);
          });
        });
      });
    }

    function openChat(chatId, u) {
      activeChatId = chatId;
      // mark read
      if (chatsMeta[chatId]) {
        chatsMeta[chatId].unread = false;
      }
      // update header
      chatHeader.childNodes[0].nodeValue = `${u.name} (${u.idNumber || ""})`;
      messagesDiv.innerHTML = "";

      const msgsRef = ref(db, `chats/${chatId}/messages`);
      get(msgsRef).then(snap => {
        const msgs = [];
        snap.forEach(mSnap => {
          msgs.push(mSnap.val());
        });
        // Sort by timestamp ascending
        msgs.sort((a,b) => (a.ts || 0) - (b.ts || 0));
        msgs.forEach(m => {
          addMessageToDiv(m);
        });
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
      });

      renderChatList();
    }

    function addMessageToDiv(m) {
      const div = document.createElement("div");
      div.className = "msg " + (m.sender === currentUser.uid ? "me" : "other");
      div.innerText = m.text;
      messagesDiv.appendChild(div);
    }

    sendBtn.onclick = () => {
      if (!activeChatId) return alert("Please select a user first");
      const text = msgInput.value.trim();
      if (!text) return;
      const msgsRef = ref(db, `chats/${activeChatId}/messages`);
      const newMsgRef = push(msgsRef);
      set(newMsgRef, {
        text,
        sender: currentUser.uid,
        ts: Date.now()
      }).then(() => {
        msgInput.value = "";
        openChat(activeChatId); // refresh messages
      });
    };

    // Search by ID (basic)
    searchBtn.onclick = () => {
      const val = searchInput.value.trim();
      if (!val) {
        alert("Enter user ID to search");
        return;
      }
      // Lookup user by ID
      get(ref(db, "users")).then(snap => {
        let foundUser = null;
        snap.forEach(s => {
          if (s.val().idNumber === val) {
            foundUser = s.val();
            foundUser.uid = s.key;
          }
        });
        if (!foundUser) {
          alert("User not found");
          return;
        }
        // Open or create chat with that user
        const id1 = currentUser.uid;
        const id2 = foundUser.uid;
        const chatId = id1 < id2 ? id1 + "_" + id2 : id2 + "_" + id1;

        openChat(chatId, foundUser);
      });
    };

  </script>
</body>
</html>
