<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --bg:#f0f2f5;
      --panel:#ffffff;
      --muted:#8a8f98;
      --accent:#0078ff;
      --bubble:#e4f0ff;
      --me:#d2f8d2;
      --shadow: 0 4px 12px rgba(15, 23, 42, 0.08);
      font-family: 'Inter', system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;background:var(--bg);color:#111}

    .app{display:flex;max-width:1100px;height:86vh;margin:30px auto;border-radius:12px;overflow:hidden;box-shadow:var(--shadow);}

    .sidebar{width:320px;background:linear-gradient(180deg,#fff,#fbfdff);border-right:1px solid #e6e9ee;display:flex;flex-direction:column}
    .sidebar .search{padding:18px}
    .search input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #e4e7eb;background:#f7f9fc}
    .contacts{flex:1;overflow:auto;padding:6px 0}
    .contact{display:flex;align-items:center;padding:12px 16px;gap:12px;cursor:pointer}
    .contact:hover{background:#f5f7fb}
    .avatar{width:44px;height:44px;border-radius:50%;flex-shrink:0;background:linear-gradient(135deg,#cfe9ff,#ffdcdc);display:inline-flex;align-items:center;justify-content:center;font-weight:700;color:#fff}
    .meta{flex:1;display:flex;justify-content:space-between;align-items:center}
    .meta .name{font-weight:600}
    .meta .last{font-size:13px;color:var(--muted)}

    .main{flex:1;display:flex;flex-direction:column;background:var(--panel)}
    .header{display:flex;align-items:center;padding:14px 18px;border-bottom:1px solid #eef1f5}
    .header .title{font-weight:600}
    .header .subtitle{font-size:13px;color:var(--muted);margin-left:8px}
    .messages{flex:1;padding:20px;overflow:auto;background:linear-gradient(180deg, #f7fbff 0%, transparent 40%)}
    .bubble-row{display:flex;margin-bottom:10px;align-items:flex-end;position:relative}
    .bubble{max-width:70%;padding:10px 14px;border-radius:18px;line-height:1.2;font-size:14px;position:relative}
    .from{background:var(--bubble);border-bottom-left-radius:4px}
    .to{background:var(--me);margin-left:auto;border-bottom-right-radius:4px}
    .time{display:block;font-size:11px;color:var(--muted);margin-top:6px}

    .composer{padding:12px;border-top:1px solid #eef1f5;display:flex;gap:10px;align-items:center}
    .composer input[type='text']{flex:1;padding:10px 12px;border-radius:999px;border:1px solid #e8ebf0;background:#fff}
    .btn{background:var(--accent);color:#fff;padding:8px 12px;border-radius:10px;border:none;cursor:pointer}
    .muted{color:var(--muted);font-size:13px}
    #userInfo { font-size: 13px; color: var(--muted); padding: 10px 16px; border-bottom: 1px solid #e6e9ee; }
    @media (max-width:880px){.sidebar{display:none}.app{max-width:100%;height:100vh;border-radius:0}}
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div id="userInfo">Loading...</div>
      <div class="search">
        <input id="search" placeholder="Search or start new chat" />
      </div>
      <div class="contacts" id="contacts"></div>
    </aside>

    <main class="main">
      <div class="header">
        <div style="display:flex;align-items:center;gap:12px">
          <div class="avatar" id="chatAvatar">A</div>
          <div>
            <div class="title" id="chatName">Select a conversation</div>
            <div class="subtitle" id="chatStatus">Offline</div>
          </div>
        </div>
        <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
          <button class="btn" id="newChat">New Chat</button>
        </div>
      </div>

      <div class="messages" id="messages"></div>

      <div class="composer">
        <input id="msgInput" type="text" placeholder="Type a message... (press Enter to send)" />
        <button class="btn" id="sendBtn">Send</button>
      </div>
    </main>
  </div>

  <!-- Firebase SDKs (non-module for wide compatibility) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-database-compat.js"></script>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyAhT_VolZsIz7F_AxnVkagd85ngXCGErQw",
      authDomain: "csat-2d59c.firebaseapp.com",
      databaseURL: "https://csat-2d59c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "csat-2d59c",
      storageBucket: "csat-2d59c.appspot.com",
      messagingSenderId: "250094013303",
      appId: "1:250094013303:web:6e6dd3ee0dcac726486f72"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.database();

    let currentUser = null;
    let activeChatId = null;
    let otherUserId = null;

    const contactsEl = document.getElementById('contacts');
    const messagesEl = document.getElementById('messages');
    const chatNameEl = document.getElementById('chatName');
    const chatAvatarEl = document.getElementById('chatAvatar');
    const userInfoEl = document.getElementById('userInfo');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    function renderContacts(list) {
      contactsEl.innerHTML = '';
      list.forEach(c => {
        const el = document.createElement('div');
        el.className = 'contact';
        el.innerHTML = `
          <div class="avatar">${c.avatar}</div>
          <div class="meta">
            <div style="display:flex;flex-direction:column">
              <div class="name">${c.name}</div>
              <div class="last muted">${c.latestMsgText || ''}</div>
            </div>
          </div>`;
        el.onclick = () => openChat(c.chatId, c.otherUid, c.name, c.avatar);
        contactsEl.appendChild(el);
      });
    }

    function renderMessages(snapshot) {
      messagesEl.innerHTML = '';
      snapshot.forEach(msgSnap => {
        const m = msgSnap.val();
        const row = document.createElement('div');
        row.className = 'bubble-row';
        const b = document.createElement('div');
        b.className = 'bubble ' + (m.from === currentUser.uid ? 'to' : 'from');
        b.innerHTML = `<div>${m.text}</div><div class='time'>${m.time}</div>`;
        row.appendChild(b);
        messagesEl.appendChild(row);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function openChat(chatId, uid, name, avatar) {
      activeChatId = chatId;
      otherUserId = uid;
      chatNameEl.textContent = name;
      chatAvatarEl.textContent = avatar;
      db.ref("messages/" + chatId).on('value', renderMessages);
    }

    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text || !activeChatId) return;
      const now = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });

      db.ref("messages/" + activeChatId).push({
        from: currentUser.uid,
        text,
        time: now
      });

      const meta = { latestMsgText: text, latestMsgTs: Date.now() };
      db.ref("chatsMeta/" + currentUser.uid + "/" + activeChatId).update(meta);
      db.ref("chatsMeta/" + otherUserId + "/" + activeChatId).update(meta);

      msgInput.value = "";
    }

    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    document.getElementById('newChat').addEventListener('click', () => {
      const uid = prompt("Enter other user's UID:");
      if (!uid || uid === currentUser.uid) return;
      const chatId = [currentUser.uid, uid].sort().join("_");
      const metaInit = { latestMsgText: '', latestMsgTs: Date.now() };
      db.ref("chatsMeta/" + currentUser.uid + "/" + chatId).update(metaInit);
      db.ref("chatsMeta/" + uid + "/" + chatId).update(metaInit);
      openChat(chatId, uid, uid.substring(0,5).toUpperCase(), uid.substring(0,2).toUpperCase());
    });

    function setupMetaListener() {
      db.ref("chatsMeta/" + currentUser.uid).on('value', snap => {
        const list = [];
        snap.forEach(child => {
          const chatId = child.key;
          const meta = child.val();
          const parts = chatId.split("_");
          const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
          list.push({
            chatId,
            otherUid,
            name: otherUid.substring(0, 5).toUpperCase(),
            avatar: otherUid.substring(0, 2).toUpperCase(),
            latestMsgText: meta.latestMsgText || ''
          });

          // Attach real-time listener to messages (fix for real-time receive)
          db.ref("messages/" + chatId).on('value', msgSnap => {
            if (chatId === activeChatId) renderMessages(msgSnap);
          });
        });
        renderContacts(list);
      });
    }

    auth.onAuthStateChanged(user => {
      if (user) {
        currentUser = user;
        const displayName = "Anonymous-" + user.uid.substring(0, 6);
        userInfoEl.innerHTML = `Logged in as: <strong>${displayName}</strong><br><small>${user.uid}</small>`;
        setupMetaListener();
      }
    });

    auth.signInAnonymously();
  </script>
</body>
</html>
