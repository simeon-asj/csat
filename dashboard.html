<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Firebase Chat</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
  <style>
    /* same styles as your original, unchanged for brevity */
  </style>
</head>
<body>
  <div class="app">
    <!-- unchanged UI layout -->
    ...
  </div>

  <!-- Firebase Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getDatabase, ref, onValue, push, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";
    import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhT_VolZsIz7F_AxnVkagd85ngXCGErQw",
      authDomain: "csat-2d59c.firebaseapp.com",
      databaseURL: "https://csat-2d59c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "csat-2d59c",
      storageBucket: "csat-2d59c.firebasedestorage.app",
      messagingSenderId: "250094013303",
      appId: "1:250094013303:web:6e6dd3ee0dcac726486f72",
      measurementId: "G-YEJ32DTM64"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth();

    let currentUser = null;
    let activeChatId = null;
    let otherUserId = null;

    const contactsEl = document.getElementById('contacts');
    const messagesEl = document.getElementById('messages');
    const chatNameEl = document.getElementById('chatName');
    const chatAvatarEl = document.getElementById('chatAvatar');
    const chatStatusEl = document.getElementById('chatStatus');
    const msgInput = document.getElementById('msgInput');
    const sendBtn = document.getElementById('sendBtn');

    function renderContacts(list) {
      contactsEl.innerHTML = '';
      list.forEach(c => {
        const el = document.createElement('div');
        el.className = 'contact';
        el.innerHTML = `
          <div class="avatar">${c.avatar}</div>
          <div class="meta">
            <div style="display:flex;flex-direction:column">
              <div class="name">${c.name}</div>
              <div class="last muted">${c.latestMsgText || ''}</div>
            </div>
          </div>`;
        el.onclick = () => openChat(c.chatId, c.otherUid, c.name, c.avatar);
        contactsEl.appendChild(el);
      });
    }

    function renderMessages(snapshot) {
      messagesEl.innerHTML = '';
      snapshot.forEach(msgSnap => {
        const m = msgSnap.val();
        const row = document.createElement('div');
        row.className = 'bubble-row';
        const b = document.createElement('div');
        b.className = 'bubble ' + (m.from === currentUser.uid ? 'to' : 'from');
        b.innerHTML = `<div>${m.text}</div><div class='time'>${m.time}</div>`;
        row.appendChild(b);
        messagesEl.appendChild(row);
      });
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function openChat(chatId, uid, name, avatar) {
      activeChatId = chatId;
      otherUserId = uid;
      chatNameEl.textContent = name;
      chatAvatarEl.textContent = avatar;
      onValue(ref(db, "messages/" + chatId), renderMessages);
    }

    function listenForChats() {
      onValue(ref(db, "chatsMeta/" + currentUser.uid), snap => {
        const list = [];
        snap.forEach(child => {
          const chatId = child.key;
          const meta = child.val();
          const parts = chatId.split("_");
          const otherUid = parts[0] === currentUser.uid ? parts[1] : parts[0];
          list.push({
            chatId,
            otherUid,
            name: otherUid.substring(0, 5).toUpperCase(),
            avatar: otherUid.substring(0, 2).toUpperCase(),
            latestMsgText: meta.latestMsgText || ''
          });

          // âœ… Listen to each chat to update contact list live
          onValue(ref(db, "messages/" + chatId), msgSnap => {
            if (chatId === activeChatId) renderMessages(msgSnap);
          });
        });
        renderContacts(list);
      });
    }

    function sendMessage() {
      const text = msgInput.value.trim();
      if (!text || !activeChatId) return;
      const now = new Date().toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});

      push(ref(db, "messages/" + activeChatId), {
        from: currentUser.uid,
        text,
        time: now
      });

      const metaUpdate = { latestMsgText: text, latestMsgTs: Date.now() };
      update(ref(db, "chatsMeta/" + currentUser.uid + "/" + activeChatId), metaUpdate);
      update(ref(db, "chatsMeta/" + otherUserId + "/" + activeChatId), metaUpdate);

      msgInput.value = "";
    }

    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    document.getElementById('newChat').addEventListener('click', () => {
      const uid = prompt("Enter other user's UID:");
      if (!uid || uid === currentUser.uid) return;
      const chatId = [currentUser.uid, uid].sort().join("_");
      const metaInit = { latestMsgText: '', latestMsgTs: Date.now() };
      update(ref(db, "chatsMeta/" + currentUser.uid + "/" + chatId), metaInit);
      update(ref(db, "chatsMeta/" + uid + "/" + chatId), metaInit);
      openChat(chatId, uid, uid.substring(0,5).toUpperCase(), uid.substring(0,2).toUpperCase());
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        listenForChats();
      }
    });

    signInAnonymously(auth);
  </script>
</body>
</html>
