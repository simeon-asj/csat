<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>User Dashboard</title>
  <style>
    /* ===== Base ===== */
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      background: #0e0e0e;
      color: #fff;
      height: 100vh;
      display: flex;
    }
    button, input {
      outline: none;
      border: none;
      font-family: inherit;
    }

    /* ===== Sidebar ===== */
    .sidebar {
      width: 260px;
      background: #1a1a1a;
      display: flex;
      flex-direction: column;
      border-right: 1px solid #262626;
    }
    #userInfo {
      padding: 12px;
      background: #111;
      border-bottom: 1px solid #262626;
      font-size: 13px;
    }
    #userInfo b {
      font-weight: 600;
    }
    #userId {
      cursor: pointer;
      color: #03a9f4;
      text-decoration: underline;
    }
    #userId:hover {
      color: #29b6f6;
    }
    .searchBox {
      display: flex;
      gap: 4px;
      padding: 8px;
      border-bottom: 1px solid #262626;
    }
    .searchBox input {
      flex: 1;
      padding: 6px 8px;
      border-radius: 5px;
      background: #242424;
      color: #fff;
      font-size: 13px;
    }
    .searchBox button {
      padding: 6px 8px;
      border-radius: 5px;
      background: #e91e63;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    #chatList {
      flex: 1;
      overflow-y: auto;
      font-size: 13px;
    }
    .chat-item {
      display: flex;
      flex-direction: column;
      padding: 10px;
      border-bottom: 1px solid #262626;
      cursor: pointer;
    }
    .chat-item:hover {
      background: #2a2a2a;
    }
    .chat-item .top-line {
      display: flex;
      justify-content: space-between;
    }
    .chat-item .name-id {
      /* Will be bold if unread */
    }
    .chat-item.unread .name-id {
      font-weight: bold;
    }
    .chat-item .latest-msg {
      color: #aaa;
      font-size: 12px;
      margin-top: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ===== Main ===== */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }
    .header {
      padding: 12px 16px;
      background: #111;
      font-weight: 600;
      font-size: 14px;
      border-bottom: 1px solid #262626;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .logout {
      padding: 4px 10px;
      border-radius: 5px;
      background: #e53935;
      color: #fff;
      cursor: pointer;
      font-size: 13px;
    }
    .logout:hover {
      background: #d32f2f;
    }

    /* ===== Messages ===== */
    .messages {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
      background: #121212;
    }
    .msg {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 18px;
      font-size: 14px;
      line-height: 1.4em;
      position: relative;
      word-wrap: break-word;
    }
    .msg.me {
      align-self: flex-end;
      background: #ff0073;
      color: #fff;
      border-bottom-right-radius: 4px;
    }
    .msg.other {
      align-self: flex-start;
      background: #2a2a2a;
      color: #fff;
      border-bottom-left-radius: 4px;
    }

    /* ===== Input Row ===== */
    .inputRow {
      display: flex;
      padding: 12px 16px;
      gap: 8px;
      border-top: 1px solid #262626;
      background: #111;
    }
    .inputRow input {
      flex: 1;
      padding: 10px 16px;
      border-radius: 20px;
      background: #242424;
      color: #fff;
      font-size: 14px;
    }
    .inputRow button {
      padding: 10px 16px;
      border-radius: 20px;
      background: #e91e63;
      color: #fff;
      cursor: pointer;
      font-size: 14px;
    }
    .inputRow button:hover {
      background: #d81b60;
    }
  </style>
</head>
<body>

  <!-- Sidebar -->
  <div class="sidebar">
    <!-- User Info Bar -->
    <div id="userInfo">
      Logged in as: <b id="userName">Loading...</b><br>
      ID: <small id="userId" title="Click to copy">Loading...</small>
    </div>
    <div class="searchBox">
      <input id="searchUser" placeholder="Search IDâ€¦">
      <button id="searchBtn">Go</button>
    </div>
    <div id="chatList"></div>
  </div>

  <!-- Main Chat -->
  <div class="main">
    <div id="chatHeader" class="header">
      Select a user
      <button id="logoutBtn" class="logout">Logout</button>
    </div>
    <div id="messages" class="messages"></div>
    <div class="inputRow">
      <input id="msgInput" placeholder="Type a message">
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Notification Sound -->
  <audio id="notifSound" src="https://notificationsounds.com/storage/sounds/file-sounds-1152-pristine.mp3" preload="auto"></audio>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
    import { getDatabase, ref, get, child, push, set, onChildAdded, onValue, update } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAhT_VolZsIz7F_AxnVkagd85ngXCGErQw",
      authDomain: "csat-2d59c.firebaseapp.com",
      databaseURL: "https://csat-2d59c-default-rtdb.asia-southeast1.firebasedatabase.app",
      projectId: "csat-2d59c",
      storageBucket: "csat-2d59c.firebasestorage.app",
      messagingSenderId: "250094013303",
      appId: "1:250094013303:web:6e6dd3ee0dcac726486f72",
      measurementId: "G-YEJ32DTM64"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    const logoutBtn   = document.getElementById("logoutBtn");
    const chatList    = document.getElementById("chatList");
    const msgInput    = document.getElementById("msgInput");
    const sendBtn     = document.getElementById("sendBtn");
    const chatHeader  = document.getElementById("chatHeader");
    const messagesDiv = document.getElementById("messages");
    const searchBtn   = document.getElementById("searchBtn");
    const searchInput = document.getElementById("searchUser");
    const notifSound  = document.getElementById("notifSound");
    const userNameEl  = document.getElementById("userName");
    const userIdEl    = document.getElementById("userId");

    let currentUser = null;
    let activeChatId = null;
    // Keep a map of latest message data and read status per chat
    let chatsMeta = {};  
    // Format: { chatId1: { latestMsgText: "...", latestMsgTs: <timestamp>, unread: true/false }, chatId2: { ... } }

    // Helper to sort chats by latest timestamp
    function sortChatsByLatest(a, b) {
      const ma = chatsMeta[a]?.latestMsgTs || 0;
      const mb = chatsMeta[b]?.latestMsgTs || 0;
      // descending: newest first
      return mb - ma;
    }

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        location.href = "index.html";
        return;
      }
      currentUser = user;

      // get user name & ID
      const uSnap = await get(ref(db, "users/" + currentUser.uid));
      if (uSnap.exists()) {
        const u = uSnap.val();
        userNameEl.textContent = u.name || "N/A";
        userIdEl.textContent = u.idNumber || "N/A";
      }

      // listener for when chats change (to build meta)
      const chatsRef = ref(db, "chats");
      // Use onValue or onChildAdded + onChildChanged to catch updates
      onChildAdded(chatsRef, snap => {
        const chatId = snap.key;
        if (!chatsMeta[chatId]) {
          chatsMeta[chatId] = { latestMsgText: "", latestMsgTs: 0, unread: false };
        }
        // Also listen for messages within this chat
        const msgsRef = ref(db, `chats/${chatId}/messages`);
        onChildAdded(msgsRef, msgSnap => {
          const m = msgSnap.val();
          const ts = m.ts || 0;
          const text = m.text || "";
          // update meta
          if (ts > (chatsMeta[chatId].latestMsgTs || 0)) {
            chatsMeta[chatId].latestMsgTs = ts;
            chatsMeta[chatId].latestMsgText = text;
          }
          // If message is from someone else and this chat is not active, mark unread
          if (m.sender !== currentUser.uid && activeChatId !== chatId) {
            chatsMeta[chatId].unread = true;
            // play sound
            notifSound.play().catch(e => console.warn("Notif sound error:", e));
            renderChatList();
          }
          else {
            // if it is active chat, mark read
            if (activeChatId === chatId) {
              chatsMeta[chatId].unread = false;
              renderChatList();
            }
          }
        });
      });

      // initial render
      renderChatList();
    });

    userIdEl.addEventListener("click", () => {
      navigator.clipboard.writeText(userIdEl.textContent)
        .then(() => alert("User ID copied to clipboard!"))
        .catch(() => alert("Failed to copy ID."));
    });

    logoutBtn.onclick = async () => {
      await signOut(auth);
      location.href = "index.html";
    };

    function renderChatList() {
      // clear
      chatList.innerHTML = "";
      const chatsRef = ref(db, "chats");
      get(chatsRef).then(chatsSnap => {
        const chatIds = [];
        chatsSnap.forEach(snap => {
          const chatId = snap.key;
          const data = snap.val();
          if (!data.messages) return;
          const ids = chatId.split("_");
          if (!ids.includes(currentUser.uid)) return;
          chatIds.push(chatId);
        });
        // sort by latest message timestamp
        chatIds.sort(sortChatsByLatest);
        // for each, build item
        chatIds.forEach(chatId => {
          const meta = chatsMeta[chatId] || { latestMsgText: "", latestMsgTs: 0, unread: false };
          const ids = chatId.split("_");
          const otherUid = (ids[0] === currentUser.uid ? ids[1] : ids[0]);
          get(child(ref(db), "users/" + otherUid)).then(uSnap => {
            if (!uSnap.exists()) return;
            const u = uSnap.val();
            // build element
            const div = document.createElement("div");
            div.className = "chat-item" + (meta.unread ? " unread" : "");
            // top line with name and ID
            const topLine = document.createElement("div");
            topLine.className = "top-line";
            const nameId = document.createElement("div");
            nameId.className = "name-id";
            nameId.innerText = `${u.name} ${u.idNumber ? (" " + u.idNumber) : ""}`;
            topLine.appendChild(nameId);
            // optional: timestamp display could go at right but we skip for simplicity
            div.appendChild(topLine);
            // latest message
            const lm = document.createElement("div");
            lm.className = "latest-msg";
            lm.innerText = meta.latestMsgText || "";
            div.appendChild(lm);
            // click to open chat
            div.onclick = () => {
              openChat(chatId, u);
            };
            chatList.appendChild(div);
          });
        });
      });
    }

    function openChat(chatId, u) {
      activeChatId = chatId;
      // mark as read
      if (chatsMeta[chatId]) {
        chatsMeta[chatId].unread = false;
      }
      // update header
      chatHeader.childNodes[0].nodeValue = `${u.name} (${u.idNumber || ""})`;
      messagesDiv.innerHTML = "";

      const msgsRef = ref(db, `chats/${chatId}/messages`);
      onChildAdded(msgsRef, snap => {
        const m = snap.val();
        const isMine = (m.sender === currentUser.uid);
        const div = document.createElement("div");
        div.className = isMine ? "msg me" : "msg other";
        div.textContent = m.text;
        messagesDiv.appendChild(div);
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
        // since user is seeing this chat, mark as read
        if (!isMine) {
          if (chatsMeta[chatId]) {
            chatsMeta[chatId].unread = false;
            renderChatList();
          }
        }
      });
      // re-render sidebar so bold/unread removal happens
      renderChatList();
    }

    function sendMessage() {
      if (!activeChatId || !msgInput.value.trim()) return;
      push(ref(db, `chats/${activeChatId}/messages`), {
        sender: currentUser.uid,
        text: msgInput.value,
        ts: Date.now()
      });
      msgInput.value = "";
    }
    sendBtn.onclick = sendMessage;
    msgInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    searchBtn.onclick = async () => {
      const id = searchInput.value.trim();
      if (!id) return;
      const usersSnap = await get(ref(db, "users"));
      let found = null;
      usersSnap.forEach(s => {
        const d = s.val();
        if (d.idNumber === id) found = { uid: s.key, ...d };
      });
      if (found) {
        const chatId = currentUser.uid < found.uid
          ? `${currentUser.uid}_${found.uid}`
          : `${found.uid}_${currentUser.uid}`;
        await set(ref(db, "chats/" + chatId), {});
        openChat(chatId, found);
      } else {
        alert("User ID not found");
      }
    };

  </script>

</body>
</html>
