<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Chat Dashboard</title>
<style>
  body{margin:0;font-family:sans-serif;background:#111;color:#fff;display:flex;height:100vh}
  /* left panel */
  #sidebar{width:250px;background:#1e1e1e;display:flex;flex-direction:column}
  #searchBox{margin:10px;padding:8px;border:none;border-radius:4px}
  #chatList{flex:1;overflow-y:auto}
  .chatItem{padding:10px;border-bottom:1px solid #333;cursor:pointer}
  .chatItem:hover{background:#333}
  /* right panel */
  #chatPanel{flex:1;display:flex;flex-direction:column}
  #messages{flex:1;padding:10px;overflow-y:auto}
  .msg{margin:4px 0;max-width:60%;padding:8px;border-radius:8px}
  .me{background:#2ecc71;margin-left:auto}
  .them{background:#555}
  #inputBar{display:flex;padding:10px;background:#1e1e1e}
  #textInput{flex:1;padding:8px;border:none;border-radius:4px}
  #sendBtn,#imgBtn{margin-left:5px;padding:8px 12px;border:none;border-radius:4px;background:#2ecc71;color:#fff;cursor:pointer}
  img.chat-img{max-width:200px;border-radius:6px;display:block;margin-top:4px}
</style>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-storage-compat.js"></script>
</head>
<body>
  <div id="sidebar">
    <input id="searchBox" placeholder="Search IDâ€¦">
    <div id="chatList"></div>
  </div>

  <div id="chatPanel">
    <div id="messages"></div>
    <div id="inputBar">
      <input id="textInput" placeholder="Type a message">
      <button id="imgBtn">ðŸ“·</button>
      <button id="sendBtn">Send</button>
      <input type="file" id="imgFile" accept="image/*" style="display:none">
    </div>
  </div>

<script>
/* ---------- Firebase init ---------- */
const firebaseConfig = {
  apiKey: "YOUR_KEY",
  authDomain: "YOUR_PROJECT.firebaseapp.com",
  projectId: "YOUR_PROJECT",
  storageBucket: "YOUR_PROJECT.appspot.com",
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db   = firebase.firestore();
const storage = firebase.storage();

let currentUser=null,currentChat=null;

/* ---------- Auth (anonymous for demo) ---------- */
auth.signInAnonymously().then(()=>console.log("Signed in")).catch(console.error);

/* ---------- UI elements ---------- */
const chatList=document.getElementById("chatList");
const messagesDiv=document.getElementById("messages");
const textInput=document.getElementById("textInput");
const sendBtn=document.getElementById("sendBtn");
const searchBox=document.getElementById("searchBox");
const imgBtn=document.getElementById("imgBtn");
const imgFile=document.getElementById("imgFile");

/* ---------- Load chats ---------- */
auth.onAuthStateChanged(user=>{
  if(!user) return;
  currentUser=user.uid;

  // show only conversations where current user participated
  db.collection("conversations")
    .where("members","array-contains",currentUser)
    .orderBy("lastAt","desc")
    .onSnapshot(snap=>{
      chatList.innerHTML="";
      snap.forEach(doc=>{
        const data=doc.data();
        const other = data.members.find(m=>m!==currentUser);
        const item=document.createElement("div");
        item.className="chatItem";
        item.textContent=other;
        item.onclick=()=>openChat(doc.id,other);
        chatList.appendChild(item);
      });
    });
});

/* ---------- Search user id to start chat ---------- */
searchBox.addEventListener("keypress",e=>{
  if(e.key==="Enter" && searchBox.value.trim()){
    const otherId = searchBox.value.trim();
    startChat(otherId);
    searchBox.value="";
  }
});

function startChat(otherId){
  // look for existing convo first
  db.collection("conversations")
    .where("members","in",[[currentUser,otherId],[otherId,currentUser]])
    .get().then(q=>{
      if(!q.empty){
        openChat(q.docs[0].id,otherId);
      }else{
        db.collection("conversations").add({
          members:[currentUser,otherId],
          lastAt:firebase.firestore.FieldValue.serverTimestamp()
        }).then(doc=>openChat(doc.id,otherId));
      }
    });
}

/* ---------- Open chat ---------- */
let unsubscribeMsg=null;
function openChat(chatId,otherId){
  currentChat=chatId;
  messagesDiv.innerHTML="";
  if(unsubscribeMsg) unsubscribeMsg();
  unsubscribeMsg=db.collection("conversations").doc(chatId)
    .collection("messages").orderBy("created")
    .onSnapshot(snap=>{
      messagesDiv.innerHTML="";
      snap.forEach(doc=>{
        const d=doc.data();
        const div=document.createElement("div");
        div.className="msg "+(d.from===currentUser?"me":"them");
        if(d.text) div.textContent=d.text;
        if(d.imageUrl){
          const img=document.createElement("img");
          img.src=d.imageUrl;
          img.className="chat-img";
          div.appendChild(img);
        }
        messagesDiv.appendChild(div);
      });
      messagesDiv.scrollTop=messagesDiv.scrollHeight;
    });
}

/* ---------- Send text ---------- */
function sendText(){
  if(!currentChat || !textInput.value.trim()) return;
  const txt=textInput.value;
  textInput.value="";
  const msg={
    from:currentUser,text:txt,
    created:firebase.firestore.FieldValue.serverTimestamp()
  };
  db.collection("conversations").doc(currentChat)
    .collection("messages").add(msg);
  db.collection("conversations").doc(currentChat)
    .update({lastAt:firebase.firestore.FieldValue.serverTimestamp()});
}
sendBtn.onclick=sendText;
textInput.addEventListener("keypress",e=>{if(e.key==="Enter")sendText();});

/* ---------- Send image ---------- */
imgBtn.onclick=()=>imgFile.click();
imgFile.onchange=()=>{
  if(!currentChat || !imgFile.files[0]) return;
  const file=imgFile.files[0];
  const ref=storage.ref("chatImages/"+Date.now()+"_"+file.name);
  ref.put(file).then(()=>ref.getDownloadURL()).then(url=>{
    db.collection("conversations").doc(currentChat)
      .collection("messages").add({
        from:currentUser,imageUrl:url,
        created:firebase.firestore.FieldValue.serverTimestamp()
      });
    db.collection("conversations").doc(currentChat)
      .update({lastAt:firebase.firestore.FieldValue.serverTimestamp()});
  });
};


  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-auth.js";
import { getDatabase, ref, get, child, push, set, onChildAdded, query, orderByChild } from "https://www.gstatic.com/firebasejs/9.22.2/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyAhT_VolZsIz7F_AxnVkagd85ngXCGErQw",
  authDomain: "csat-2d59c.firebaseapp.com",
  databaseURL: "https://csat-2d59c-default-rtdb.asia-southeast1.firebasedatabase.app",
  projectId: "csat-2d59c",
  storageBucket: "csat-2d59c.firebasestorage.app",
  messagingSenderId: "250094013303",
  appId: "1:250094013303:web:6e6dd3ee0dcac726486f72",
  measurementId: "G-YEJ32DTM64"
};
</script>
</body>
</html>
