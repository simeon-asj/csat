<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Messenger Dark Chat</title>
  <style>
    <h1>CHAT V2</h1>
    body {
      margin:0;
      font-family: Arial, sans-serif;
      background:#18191a;
      color:#e4e6eb;
      display:flex;
      height:100vh;
      overflow:hidden;
    }
    .sidebar {
      width:300px;
      background:#242526;
      border-right:1px solid #3a3b3c;
      display:flex;
      flex-direction:column;
    }
    .sidebar-header {
      padding:12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      border-bottom:1px solid #3a3b3c;
    }
    .contacts {
      flex:1;
      overflow-y:auto;
    }
    .contact {
      display:flex;
      align-items:center;
      padding:10px;
      cursor:pointer;
      border-bottom:1px solid #3a3b3c;
    }
    .contact:hover {
      background:#3a3b3c;
    }
    .avatar {
      width:40px;
      height:40px;
      border-radius:50%;
      background:linear-gradient(45deg,#8a3ab9,#bc2a8d);
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:bold;
      margin-right:10px;
    }
    .meta {
      flex:1;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .name {
      font-weight:bold;
    }
    .last {
      font-size:13px;
      color:#b0b3b8;
    }
    .time {
      font-size:12px;
      color:#b0b3b8;
      margin-left:8px;
    }
    .chat-area {
      flex:1;
      display:flex;
      flex-direction:column;
    }
    .chat-header {
      padding:12px;
      border-bottom:1px solid #3a3b3c;
      font-weight:bold;
    }
    .messages {
      flex:1;
      overflow-y:auto;
      padding:12px;
      display:flex;
      flex-direction:column;
    }
    .message {
      max-width:60%;
      margin:4px 0;
      padding:8px 12px;
      border-radius:18px;
      line-height:1.4;
    }
    .sent {
      align-self:flex-end;
      background:#0084ff;
      color:white;
    }
    .received {
      align-self:flex-start;
      background:#3a3b3c;
      color:white;
    }
    .composer {
      padding:10px;
      border-top:1px solid #3a3b3c;
      display:flex;
    }
    .composer input {
      flex:1;
      border:none;
      border-radius:20px;
      padding:10px 15px;
      background:#3a3b3c;
      color:white;
      outline:none;
    }
    .composer button {
      margin-left:8px;
      padding:0 16px;
      border:none;
      border-radius:20px;
      background:#0084ff;
      color:white;
      cursor:pointer;
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <span>Chats</span>
      <button id="logoutBtn">Logout</button>
    </div>
    <div id="contactsList" class="contacts"></div>
  </div>

  <div class="chat-area">
    <div id="chatHeader" class="chat-header">Select a chat</div>
    <div id="messagesList" class="messages"></div>
    <div class="composer">
      <input id="messageInput" type="text" placeholder="Type a message..."/>
      <button id="sendBtn">Send</button>
    </div>
  </div>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getDatabase, ref, push, set, onChildAdded, serverTimestamp, get, child } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";
    import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } 
      from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    // TODO: replace with your config
    const firebaseConfig = {
      apiKey: "YOUR_KEY",
      authDomain: "YOUR_APP.firebaseapp.com",
      projectId: "YOUR_APP",
      storageBucket: "YOUR_APP.appspot.com",
      messagingSenderId: "XXXX",
      appId: "1:XXXX:web:XXXX",
      databaseURL: "https://YOUR_APP.firebaseio.com"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();

    const contactsList = document.getElementById("contactsList");
    const messagesList = document.getElementById("messagesList");
    const chatHeader = document.getElementById("chatHeader");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");
    const logoutBtn = document.getElementById("logoutBtn");

    let currentUser = null;
    let activeChatId = null;
    let userCache = {};
    let chatsMeta = {};

    // --- Auth ---
    onAuthStateChanged(auth, (user) => {
      if (user) {
        currentUser = user;
        loadUserChats();
      } else {
        signInWithPopup(auth, provider);
      }
    });

    logoutBtn.onclick = () => signOut(auth);

    // --- Load chats ---
    function loadUserChats() {
      const chatsRef = ref(db, "userChats/" + currentUser.uid);
      onChildAdded(chatsRef, (snap) => {
        const chatId = snap.key;
        listenToChat(chatId);
      });
    }

    function listenToChat(chatId) {
      const msgsRef = ref(db, "chats/" + chatId + "/messages");
      onChildAdded(msgsRef, (snap) => {
        const msg = snap.val();
        chatsMeta[chatId] = {
          latestMsgText: msg.text,
          latestMsgTs: msg.timestamp
        };
        updateContactRow(chatId);
        if (activeChatId === chatId) {
          renderMessage(msg);
        }
      });
    }

    async function getUserInfo(uid) {
      if (userCache[uid]) return userCache[uid];
      const snap = await get(child(ref(db), "users/" + uid));
      if (snap.exists()) {
        userCache[uid] = snap.val();
        return userCache[uid];
      }
      return { name: "Unknown", uid };
    }

    async function updateContactRow(chatId) {
      const ids = chatId.split("_");
      const otherUid = ids[0] === currentUser.uid ? ids[1] : ids[0];
      const otherUser = await getUserInfo(otherUid);

      let row = document.querySelector(`[data-chatid="${chatId}"]`);
      if (!row) {
        row = document.createElement("div");
        row.className = "contact";
        row.dataset.chatid = chatId;
        row.onclick = () => openChat(otherUid, chatId, otherUser.name);
        row.innerHTML = `
          <div class="avatar">${(otherUser.name||"U").slice(0,2).toUpperCase()}</div>
          <div class="meta">
            <div style="display:flex;flex-direction:column">
              <div class="name">${otherUser.name||"N/A"}</div>
              <div class="last muted"></div>
            </div>
            <div class="time muted"></div>
          </div>
        `;
        contactsList.appendChild(row);
      }
      row.querySelector(".last").textContent = chatsMeta[chatId]?.latestMsgText || "";
      row.querySelector(".time").textContent = chatsMeta[chatId]?.latestMsgTs
        ? new Date(chatsMeta[chatId].latestMsgTs).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"})
        : "";
    }

    // --- Chat window ---
    function openChat(otherUid, chatId, name) {
      activeChatId = chatId;
      chatHeader.textContent = name;
      messagesList.innerHTML = "";

      const msgsRef = ref(db, "chats/" + chatId + "/messages");
      onChildAdded(msgsRef, (snap) => {
        renderMessage(snap.val());
      });
    }

    function renderMessage(msg) {
      const div = document.createElement("div");
      div.className = "message " + (msg.senderId === currentUser.uid ? "sent" : "received");
      div.textContent = msg.text;
      messagesList.appendChild(div);
      messagesList.scrollTop = messagesList.scrollHeight;
    }

    sendBtn.onclick = sendMessage;
    messageInput.addEventListener("keypress", (e) => {
      if (e.key === "Enter") sendMessage();
    });

    function sendMessage() {
      if (!activeChatId || !messageInput.value.trim()) return;
      const msg = {
        senderId: currentUser.uid,
        text: messageInput.value,
        timestamp: Date.now()
      };
      const msgsRef = ref(db, "chats/" + activeChatId + "/messages");
      push(msgsRef, msg);
      messageInput.value = "";
    }
  </script>
</body>
</html>
